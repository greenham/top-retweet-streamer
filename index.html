<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Twitter Top ReTweet Live Streamer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="/assets/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 20px;
        padding-bottom: 40px;
      }

      /* Main marketing message and sign up button */
      .jumbotron {
        margin: 60px 0;
        text-align: center;
      }
      .jumbotron h1 {
        font-size: 72px;
        line-height: 1;
      }
      .jumbotron .btn {
        font-size: 21px;
        padding: 14px 24px;
      }

      div.media {
        width: 45%;
        height: 80px;
        float: left;
        margin-left: 10px;
      }
    </style>
    <link href="/assets/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/assets/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/assets/ico/apple-touch-icon-57-precomposed.png">
    <link rel="shortcut icon" href="/assets/ico/favicon.png">
  </head>

  <body>

    <div class="container">

      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li class="active"><a href="/">Home</a></li>
          <li><a href="https://github.com/greenham/top-retweet-streamer" target="_blank">About</a></li>
          <li><a href="mailto:rtstreamer@greenhamsolutions.com" target="_blank">Contact</a></li>
        </ul>
        <h3 class="muted">ReTweet Streamer</h3>
      </div>

      <div class="row-fluid hide" id="rt-container">
        <p class="pull-right"><a href="/" class="btn">Start a new search</a></p>
        <h2></h2>
        <!-- @todo add waiting indicator -->
        <div id="rt-list">Gathering results... please wait...</div>
      </div>

      <div class="jumbotron">
        <form class="form-search" id="search-form">
          <h4>Enter a search, twitter handle, or hashtag and start tracking the top retweets in realtime.</h4>
          <p><input type="text" class="input-xlarge search-query" name="search-term"></p>
          <p><button type="submit" class="btn btn-large btn-success">Start Tracking</button></p>
        </form>
      </div>

      <!-- @todo show recent searches -->

      <div class="footer"></div>

    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/assets/js/jquery-1.10.2.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      $( document ).ready(function() {

        var socket  = io.connect('http://localhost'),
            rtDiv   = $('#rt-container'),
            theList = rtDiv.find('#rt-list'),
            searchForm = $('#search-form'),
            searchTerm = null;

        var formatTweet = function(tweet) {
          var tweetDate = new Date(tweet.created_at);
          return '<div class="media well" id="tweet-'+tweet.tweet_id+'">\
              <h3 class="pull-left">\
                <a href="https://twitter.com/'+tweet.screen_name+'/status/'+tweet.tweet_id+'" target="_blank">#'+tweet.rank+'</a>\
              </h3>\
              <a class="pull-left" href="https://twitter.com/'+tweet.screen_name+'" target="_blank">\
                <img class="media-object" alt="@'+tweet.screen_name+'" style="width: 48px; height: 48px;" src="'+tweet.profile_image_url+'">\
              </a>\
              <div class="media-body">\
                <h4 class="media-heading">\
                  <a href="https://twitter.com/'+tweet.screen_name+'" target="_blank">@'+tweet.screen_name+'</a>\
                  <span class="badge badge-success">'+tweet.retweet_count.toLocaleString()+' RTs</span>\
                  <small class="pull-right muted">'+tweetDate.toLocaleString()+'</small>\
                </h4>\
                <p>'+htmlifyLinks(tweet.text)+'</p>\
              </div>\
            </div>';
        };

        var htmlifyLinks = function(text) {
          var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
          return text.replace(exp,'<a href="$1" target="_blank">$1</a>');
        };

        // @todo give some visual indication to the client of connection status/events
        socket
          .on('connecting', function() {
            console.log('Connecting to socket...');
          })
          .on('connect_failed', function() {
            console.error('Connection to socket failed!');
          })
          .on('connect', function() {
            console.log('Socket connected!');
          })
          .on('disconnect', function() {
            console.warn('Socket disconnected!');
          })
          .on('reconnecting', function() {
            console.warn('Reconnecting to socket...');
          })
          .on('reconnect_failed', function() {
            console.error('Reconnection to socket failed!');
          })
          .on('reconnect', function() {
            console.log('Reconnected to socket!');
            // resend previous filter so we can start getting results again
            socket.emit('filter', { query: searchTerm }, function() {});
          })
          .on('error', function(e) {
            console.error(e);
          })
          .on('message', function(msg) {
            console.log(msg);
          })
          .on('nodata', function() {
            theList.fadeOut('fast', function() {
              theList.html('No retweets found yet... please wait...');
              theList.fadeIn();
            });
          })
          .on('data', function(tweets) {
            // @todo only update the view if the data has actually changed?
            // @todo store local array of tweet IDs + ranks and compare with new list?
            theList.fadeOut('fast', function() {
              theList.html('');
              if (tweets.length > 0) {
                  $.each(tweets, function(index, tweet) {
                    tweet.rank = index+1;
                    var newTweet = $('<div></div>');
                    newTweet.html(formatTweet(tweet));
                    theList.append(newTweet);
                  });
              } else {
                theList.html('No retweets found yet... please wait...');
              }
              theList.fadeIn();
            });
          });

        searchForm.on('submit', function(e) {
          e.preventDefault();
          searchTerm = searchForm.find('input[name="search-term"]').val();
          if (searchTerm) {
            socket.emit('filter', { query: searchTerm }, function() {
              searchForm.fadeOut('fast', function() {
                rtDiv.find('h2').html(searchTerm);
                $('.masthead').fadeOut(function() {
                  rtDiv.fadeIn();
                });
              });
            });
          }
          return false;
        });
      });
    </script>
  </body>
</html>